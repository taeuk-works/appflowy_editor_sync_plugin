# Precompiled Binaries 빌드 워크플로우
# 태그 푸시 시 모든 플랫폼용 네이티브 라이브러리를 빌드하고 GitHub Releases에 업로드
name: Precompile Binaries

on:
  push:
    tags:
      - "v*" # v1.0.0, v0.1.0-beta 등
  workflow_dispatch: # 수동 실행 허용
    inputs:
      dry_run:
        description: "Dry run (빌드만 하고 업로드하지 않음)"
        required: false
        default: "false"

env:
  FLUTTER_VERSION: "3.38.6"

jobs:
  # ============================================================
  # Apple 플랫폼 빌드 (iOS + macOS)
  # ============================================================
  build-apple:
    name: Build Apple (iOS + macOS)
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: |
            aarch64-apple-ios
            aarch64-apple-ios-sim
            x86_64-apple-ios
            aarch64-apple-darwin
            x86_64-apple-darwin

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            rust/target/
          key: ${{ runner.os }}-cargo-apple-${{ hashFiles('rust/Cargo.lock') }}

      - name: Install Cargokit dependencies
        run: |
          cd cargokit/build_tool
          dart pub get

      - name: Build Apple targets
        env:
          PRIVATE_KEY: ${{ secrets.CARGOKIT_PRIVATE_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cd cargokit/build_tool
          dart run bin/build_tool.dart precompile-binaries \
            --repository ${{ github.repository }} \
            --manifest-dir ../../rust \
            --target aarch64-apple-ios \
            --target aarch64-apple-ios-sim \
            --target x86_64-apple-ios \
            --target aarch64-apple-darwin \
            --target x86_64-apple-darwin \
            --verbose

  # ============================================================
  # Android 플랫폼 빌드
  # ============================================================
  build-android:
    name: Build Android
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: |
            aarch64-linux-android
            armv7-linux-androideabi
            x86_64-linux-android
            i686-linux-android

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            rust/target/
          key: ${{ runner.os }}-cargo-android-${{ hashFiles('rust/Cargo.lock') }}

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Android NDK
        run: |
          sdkmanager --install "ndk;25.2.9519653"

      - name: Install Cargokit dependencies
        run: |
          cd cargokit/build_tool
          dart pub get

      - name: Build Android targets
        env:
          PRIVATE_KEY: ${{ secrets.CARGOKIT_PRIVATE_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ANDROID_NDK_HOME: ${{ env.ANDROID_HOME }}/ndk/25.2.9519653
        run: |
          cd cargokit/build_tool
          dart run bin/build_tool.dart precompile-binaries \
            --repository ${{ github.repository }} \
            --manifest-dir ../../rust \
            --target aarch64-linux-android \
            --target armv7-linux-androideabi \
            --target x86_64-linux-android \
            --target i686-linux-android \
            --android-sdk-location $ANDROID_HOME \
            --android-ndk-version 25.2.9519653 \
            --android-min-sdk-version 21 \
            --verbose

  # ============================================================
  # Windows 플랫폼 빌드
  # ============================================================
  build-windows:
    name: Build Windows
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            rust/target/
          key: ${{ runner.os }}-cargo-windows-${{ hashFiles('rust/Cargo.lock') }}

      - name: Install Cargokit dependencies
        run: |
          cd cargokit/build_tool
          dart pub get

      - name: Build Windows targets
        env:
          PRIVATE_KEY: ${{ secrets.CARGOKIT_PRIVATE_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: pwsh
        run: |
          cd cargokit/build_tool
          dart run bin/build_tool.dart precompile-binaries `
            --repository ${{ github.repository }} `
            --manifest-dir ../../rust `
            --target x86_64-pc-windows-msvc `
            --verbose

  # ============================================================
  # Linux x64 플랫폼 빌드
  # ============================================================
  build-linux-x64:
    name: Build Linux x64
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-unknown-linux-gnu

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            rust/target/
          key: ${{ runner.os }}-cargo-linux-x64-${{ hashFiles('rust/Cargo.lock') }}

      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev

      - name: Install Cargokit dependencies
        run: |
          cd cargokit/build_tool
          dart pub get

      - name: Build Linux x64 targets
        env:
          PRIVATE_KEY: ${{ secrets.CARGOKIT_PRIVATE_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cd cargokit/build_tool
          dart run bin/build_tool.dart precompile-binaries \
            --repository ${{ github.repository }} \
            --manifest-dir ../../rust \
            --target x86_64-unknown-linux-gnu \
            --verbose

  # ============================================================
  # Linux ARM64 플랫폼 빌드 (크로스 컴파일)
  # ============================================================
  build-linux-arm64:
    name: Build Linux ARM64
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-unknown-linux-gnu

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            rust/target/
          key: ${{ runner.os }}-cargo-linux-arm64-${{ hashFiles('rust/Cargo.lock') }}

      - name: Install cross-compilation tools
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu

      - name: Install Cargokit dependencies
        run: |
          cd cargokit/build_tool
          dart pub get

      - name: Build Linux ARM64 targets
        env:
          PRIVATE_KEY: ${{ secrets.CARGOKIT_PRIVATE_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER: aarch64-linux-gnu-gcc
          CC_aarch64_unknown_linux_gnu: aarch64-linux-gnu-gcc
          CXX_aarch64_unknown_linux_gnu: aarch64-linux-gnu-g++
        run: |
          cd cargokit/build_tool
          dart run bin/build_tool.dart precompile-binaries \
            --repository ${{ github.repository }} \
            --manifest-dir ../../rust \
            --target aarch64-unknown-linux-gnu \
            --verbose

  # ============================================================
  # 빌드 검증
  # ============================================================
  verify-binaries:
    name: Verify Binaries
    needs:
      [build-apple, build-android, build-windows, build-linux-x64, build-linux-arm64]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true

      - name: Install Cargokit dependencies
        run: |
          cd cargokit/build_tool
          dart pub get

      - name: Verify all binaries
        run: |
          cd cargokit/build_tool
          dart run bin/build_tool.dart verify-binaries \
            --manifest-dir ../../rust

      - name: Summary
        run: |
          echo "## Precompiled Binaries Build Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All platform binaries have been built and uploaded to GitHub Releases." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Supported Platforms:" >> $GITHUB_STEP_SUMMARY
          echo "- **iOS**: aarch64-apple-ios, aarch64-apple-ios-sim, x86_64-apple-ios" >> $GITHUB_STEP_SUMMARY
          echo "- **macOS**: aarch64-apple-darwin, x86_64-apple-darwin" >> $GITHUB_STEP_SUMMARY
          echo "- **Android**: aarch64-linux-android, armv7-linux-androideabi, x86_64-linux-android, i686-linux-android" >> $GITHUB_STEP_SUMMARY
          echo "- **Windows**: x86_64-pc-windows-msvc" >> $GITHUB_STEP_SUMMARY
          echo "- **Linux**: x86_64-unknown-linux-gnu, aarch64-unknown-linux-gnu" >> $GITHUB_STEP_SUMMARY
